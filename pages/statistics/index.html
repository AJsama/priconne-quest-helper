<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133296718-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-133296718-1');
    </script>

    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <link rel="icon" href="../../images/webpage/icon.png">

    <title>Princess Connect! Re:Dive - Quest Helper | Statistics</title>
    <meta name="title" content="Princess Connect! Re:Dive - Quest Helper | Statistics"/>

    <!-- META DATA -->
    <meta name="description" content="Equipment usage statistics for 'Princess Connect! Re:Dive' （プリンセスコネクト! Re:Dive）, based on the data used in priconne-quest-helper.">
    <meta name="author" content="S'pugn">
    <meta name="keywords" content="Princess Connect Re:Dive, プリンセスコネクト! Re:Dive, Quest Helper, S'pugn">

    <!-- OPEN GRAPH / FACEBOOK META DATA -->
    <meta property="og:title" content="Princess Connect! Re:Dive - Quest Helper | Statistics"/>
    <meta property="og:description" content="Equipment and ingredient usage statistics for 'Princess Connect! Re:Dive' （プリンセスコネクト! Re:Dive）, based on the data used in priconne-quest-helper."/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://raw.githubusercontent.com/Expugn/priconne-quest-helper/master/images/webpage/icon.png"/>
    <meta property="og:image:width" content="64"/>
    <meta property="og:image:height" content="64"/>
    <meta property="og:url" content="https://expugn.github.io/priconne-quest-helper/pages/statistics/"/>
    <meta property="og:locale" content="en_US"/>

    <!-- TWITTER META DATA -->
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="@eSpugn"/>
    <meta name="twitter:creator" content="@eSpugn"/>
    <meta name="twitter:title" content="Princess Connect! Re:Dive - Quest Helper | Statistics"/>
    <meta name="twitter:description" content="Equipment and ingredient usage statistics for 'Princess Connect! Re:Dive' （プリンセスコネクト! Re:Dive）, based on the data used in priconne-quest-helper."/>

    <!-- SCRIPTS -->
    <script src="../../vendor/jquery/jquery-3.4.1.min.js"></script>
    <script src="../../vendor/toastr/toastr.min.js"></script>
    <script src="../../vendor/modernizr/modernizr-custom.js"></script> <!-- WEBP CHECK -->
    <script src="../../scripts/console.js"></script>
    <script src="../../scripts/image-manager.js"></script>
    <script src="../../scripts/read-character-json.js"></script>
    <script src="../../scripts/read-equipment-json.js"></script>
    <script src="../../scripts/recipe-reader.js"></script>

    <!-- CSS STYLE SHEETS -->
    <link rel="stylesheet" href="../../vendor/toastr/toastr.css"/>
    <link rel="stylesheet" href="../../css/main.css"/>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<h1 class="title main_title">Princess Connect! Re:Dive - Quest Helper</h1>
<h2 class="title sub_title">Statistics</h2>

<hr>

<div id="rarity-settings" hidden>
    <br>
    <table id="rarity-settings-table" class="center-table white-background">
        <tbody>
        <tr>
            <th>
                <button id="ignore-button-common" class="item-button pointer-cursor" onclick="toggle_ignored_rarity('common')">
                    <img class="item-button-image use-webp" title="Ignore Common Items" image_folder="webpage" file_name="Placeholder_Common" src_prefix="../../" src="" alt="">
                </button>
            </th>
            <th>
                <button id="ignore-button-copper" class="item-button pointer-cursor" onclick="toggle_ignored_rarity('copper')">
                    <img class="item-button-image use-webp" title="Ignore Copper Items" image_folder="webpage" file_name="Placeholder_Copper" src_prefix="../../" src="" alt="">
                </button>
            </th>
            <th>
                <button id="ignore-button-silver" class="item-button pointer-cursor" onclick="toggle_ignored_rarity('silver')">
                    <img class="item-button-image use-webp" title="Ignore Silver Items" image_folder="webpage" file_name="Placeholder_Silver" src_prefix="../../" src="" alt="">
                </button>
            </th>
            <th>
                <button id="ignore-button-gold" class="item-button pointer-cursor" onclick="toggle_ignored_rarity('gold')">
                    <img class="item-button-image use-webp" title="Ignore Gold Items" image_folder="webpage" file_name="Placeholder_Gold" src_prefix="../../" src="" alt="">
                </button>
            </th>
            <th>
                <button id="ignore-button-purple" class="item-button pointer-cursor" onclick="toggle_ignored_rarity('purple')">
                    <img class="item-button-image use-webp" title="Ignore Purple Items" image_folder="webpage" file_name="Placeholder_Purple" src_prefix="../../" src="" alt="">
                </button>
            </th>
        </tr>
        </tbody>
    </table>
    <br>
    <table class="center-table">
        <tbody>
            <tr>
                <th>
                    <button id="version-history-button" onclick="toggle_version_history_display()" disabled>Version History</button>
                </th>
            </tr>
            <tr>
                <th>
                    <br>
                    <label for="data-type-select" hidden>Data Type Select</label>
                    <select id="data-type-select" onchange="change_display()">
                        <option value="equipment-data">Equipment Usage</option>
                        <option value="ingredient-data">Ingredient Usage</option>
                    </select>
                </th>
            </tr>
            <tr>
                <th>
                    <br>
                    <label for="equipment-data-type" hidden>Equipment Data Type</label>
                    <select id="equipment-data-type" onchange="change_equipment_data()">
                        <option value="equipment-data-current">Current Equipment Data (After 2019.08.31)</option>
                        <option value="equipment-data-legacy">Legacy Equipment Data (Before 2019.08.31)</option>
                    </select>
                </th>
            </tr>
        </tbody>
    </table>
    <br>
    <hr>
</div>

<div id="version-settings" hidden>
    <div style="margin: auto; text-align: center;">
        <button onclick="toggle_version_history_display()">Back to Statistics</button>
        <br><br>
        <label style="font-family: 'Trebuchet MS', Arial, serif;">
            Show Fragment History
            <input style="position: relative; top: 1px;" type="checkbox" onchange="toggle_version_history_type()">
        </label>
        <br><br>
        <div style="display: inline-block;">
            <label for="version-after" hidden>Version After</label><select id="version-after" onchange="document.getElementById('version-after-link').href = 'https://github.com/Expugn/priconne-quest-helper/commit/' + document.getElementById('version-after').value;"></select>
            <br>
            <a id="version-after-link" href="" target="_blank" class="commit-hyperlink">
                Commit Information
            </a>
        </div>
        <span id="version-arrow" style="padding-right: 10px; padding-left: 10px;"> ← </span>
        <div style="display: inline-block;">
            <label for="version-before" hidden>Version Before</label><select id="version-before" onchange="document.getElementById('version-before-link').href = 'https://github.com/Expugn/priconne-quest-helper/commit/' + document.getElementById('version-before').value;"></select>
            <br>
            <a id="version-before-link" href="" target="_blank" class="commit-hyperlink">
                Commit Information
            </a>
        </div>
        <br><br>
        <button onclick="compare_versions()">Compare Versions</button>
    </div>
    <hr>
</div>

<div id="all-data">
    <div id="equipment-data">
        <h2 class="category-header">Equipment Usage Rankings</h2>
        <table id="top-3-equipment" class="center-table white-background">
            <tr>
                <th><img class="placement-image use-webp" title="1st Place" image_folder="webpage" file_name="1st_Place" src_prefix="../../" src="" alt=""></th>
                <th><img class="quest-item-image quest-item-divider" title="" src="" alt=""></th>
                <th><img class="placement-image use-webp" title="2nd Place" image_folder="webpage" file_name="2nd_Place" src_prefix="../../" src="" alt=""></th>
                <th><img class="quest-item-image quest-item-divider" title="" src="" alt=""></th>
                <th><img class="placement-image use-webp" title="3rd Place" image_folder="webpage" file_name="3rd_Place" src_prefix="../../" src="" alt=""></th>
            </tr>
            <tr>
                <th><img id="full-equip-first" class="top-three-item-image first-place-item" title="" src="../../images/items/Placeholder.png" alt="">
                    <div id="full-equip-first-text" class="top-three-item-text" hidden></div></th>
                <th><img class="requested-item-image quest-item-divider" title="" src="" alt=""></th>
                <th><img id="full-equip-second" class="top-three-item-image second-place-item" title="" src="../../images/items/Placeholder.png" alt="">
                    <div id="full-equip-second-text" class="top-three-item-text" hidden></div></th>
                <th><img class="requested-item-image quest-item-divider" title="" src="" alt=""></th>
                <th><img id="full-equip-third" class="top-three-item-image third-place-item" title="" src="../../images/items/Placeholder.png" alt="">
                    <div id="full-equip-third-text" class="top-three-item-text" hidden></div></th>
            </tr>
        </table>

        <br>

        <div id="all-equipment" hidden>
            <table id="all-equipment-sorted" class="center-table white-background"></table>
        </div>
    </div>

    <div id="ingredient-data" hidden>
        <h2 class="category-header">Ingredient Usage Rankings</h2>
        <table id="top-3-ingredient" class="center-table white-background">
            <tr>
                <th><img class="placement-image use-webp" title="1st Place" image_folder="webpage" file_name="1st_Place" src_prefix="../../" src="" alt=""></th>
                <th><img class="quest-item-image quest-item-divider" title="" src="" alt=""></th>
                <th><img class="placement-image use-webp" title="2nd Place" image_folder="webpage" file_name="2nd_Place" src_prefix="../../" src="" alt=""></th>
                <th><img class="quest-item-image quest-item-divider" title="" src="" alt=""></th>
                <th><img class="placement-image use-webp" title="3rd Place" image_folder="webpage" file_name="3rd_Place" src_prefix="../../" src="" alt=""></th>
            </tr>
            <tr>
                <th><img id="ingredient-first" class="top-three-item-image first-place-item" title="" src="../../images/items/Placeholder.png" alt="">
                    <div id="ingredient-first-text" class="top-three-item-text" hidden></div></th>
                <th><img class="requested-item-image quest-item-divider" title="" src="" alt=""></th>
                <th><img id="ingredient-second" class="top-three-item-image second-place-item" title="" src="../../images/items/Placeholder.png" alt="">
                    <div id="ingredient-second-text" class="top-three-item-text" hidden></div></th>
                <th><img class="requested-item-image quest-item-divider" title="" src="" alt=""></th>
                <th><img id="ingredient-third" class="top-three-item-image third-place-item" title="" src="../../images/items/Placeholder.png" alt="">
                    <div id="ingredient-third-text" class="top-three-item-text" hidden></div></th>
            </tr>
        </table>

        <br>

        <div id="all-ingredients" hidden>
            <table id="all-ingredients-sorted" class="center-table white-background"></table>
        </div>
    </div>
</div>

<div id="version-history" class="center-div" hidden>
    <div id="equipment-history">

    </div>
    <div id="fragment-history" hidden>

    </div>
</div>
<br>
<hr>

</body>

<footer>
    <p class="footer">Made With <span class="heart-red">❤</span> By S'pugn
        <img class="footer use-webp" image_folder="webpage" file_name="HAhaa" src_prefix="../../" src="" alt="">
    </p>
    <p class="footer" id="stats-footer" hidden>
        <span id="stats" class="white-background"></span>
    </p>
</footer>

<script>
    const table_row_length = 12;

    let ignored_rarities = [];
    let all_equipment_map_sorted;
    let all_ingredients_map_sorted;
    let equipment_data_map;
    let current_display = "equipment-data";
    let version_history_json = {};

    let character_counter = 0;
    let highest_rank;

    toastr.warning("Loading...", "Status", { positionClass: "toast-top-full-width", timeOut:999999, extendedTimeOut:999999, tapToDismiss: false });
    window.onload = function ()
    {
        init_webp();
        init_images();

        // MAKE SURE EQUIPMENT AND CHARACTER DATA IS LOADED
        setup();

        function setup()
        {
            if (!equipment_loaded || !character_loaded)
            {
                setTimeout(function () {
                    setup();
                }, 1000);
            }
            else
            {
                run();
                toastr.remove();
                toastr.info("Ready!", "Status", { positionClass: "toast-top-full-width", tapToDismiss: false });
            }
        }
    };

    function run()
    {
        highest_rank = undefined;
        equipment_data_map = build_equipment_data_map();
        let all_equipment_map = compile_all_full_equipment();
        all_equipment_map_sorted = new Map([...all_equipment_map.entries()].sort((a, b) => b[1] - a[1]));
        all_ingredients_map_sorted = new Map([...compile_all_ingredients(all_equipment_map).entries()].sort((a, b) => b[1] - a[1]));
        build_full_equipment_html();
        build_full_ingredient_html();
        update_stats();
        document.getElementById("rarity-settings").hidden = false;
        setup_version_history();
    }

    function compile_all_full_equipment()
    {
        let all_equipment_map = new Map();
        character_counter = 0;

        for (let [character_name, character_data] of character_map)
        {
            // IF CHARACTER DATA IS NOT INCOMPLETE (INDICATED BY NOT HAVING A MISSING RANK 1 ITEM)
            if (get_character_data(character_name, "rank_1")[0] !== "")
            {
                let rank_counter = 1;

                while (get_character_data(character_name, "rank_" + rank_counter) !== undefined)
                {
                    // ITERATE THROUGH RANK ITEMS
                    for (let i = 0 ; i < 6 ; i++)
                    {
                        let item = get_character_data(character_name, "rank_" + rank_counter)[i];

                        // IF ITEM IS EMPTY, CHANGE TO PLACEHOLDER
                        if (item === "")
                        {
                            item = "Placeholder";
                        }

                        // ADD ITEM TO COMPLETE EQUIPMENT MAP
                        if (all_equipment_map.has(item))
                        {
                            all_equipment_map.set(item, all_equipment_map.get(item) + 1);
                        }
                        else
                        {
                            all_equipment_map.set(item, 1);
                        }
                    }
                    rank_counter++;
                }

                if (typeof highest_rank === "undefined")
                {
                    highest_rank = rank_counter - 1;
                }

                character_counter++;
            }
        }

        return all_equipment_map;
    }

    function compile_all_ingredients(all_equipment_map)
    {
        let all_ingredients_map = new Map();
        for (let [equipment_name, equipment_amount] of all_equipment_map)
        {
            // IGNORE PLACEHOLDER
            if (equipment_name !== "Placeholder")
            {
                let equipment_recipe = get_recipe(equipment_name, equipment_amount);
                for (let [ingredient_name, ingredient_amount] of equipment_recipe)
                {
                    if (all_ingredients_map.has(ingredient_name))
                    {
                        all_ingredients_map.set(ingredient_name, all_ingredients_map.get(ingredient_name) + ingredient_amount)
                    }
                    else
                    {
                        all_ingredients_map.set(ingredient_name, ingredient_amount);
                    }
                }
            }
        }

        return all_ingredients_map;
    }

    function build_equipment_data_map()
    {
        let err = new Map();
        for (let [item_name, item_data] of equipment_map)
        {
            let item_id = get_equipment_data(item_name, "id");
            let rarity_class = item_id.substring(0, item_id.indexOf('-'));

            if (rarity_class !== "misc")
            {
                let equipment_data_map = new Map();
                equipment_data_map.set("rarity", rarity_class);
                equipment_data_map.set("has_fragments", item_data.get("has_fragments"));
                equipment_data_map.set("req_pieces", item_data.get("req_pieces"));
                equipment_data_map.set("req_items", item_data.get("req_items"));

                err.set(item_data.get("name"), equipment_data_map);
            }
        }

        return err;
    }

    function build_full_equipment_html()
    {
        let item_counter = 0;
        let bottom_equipment_html = "<tbody>";

        for (let [equipment_name, equipment_amount] of all_equipment_map_sorted) {
            // IGNORE PLACEHOLDER
            if (equipment_name !== "Placeholder") {
                if (!ignored_rarities.includes(equipment_data_map.get(equipment_name).get("rarity")))
                {
                    if (item_counter < 3)
                    {
                        switch (item_counter)
                        {
                            case 0:
                                document.getElementById("full-equip-first").src = "../../" + get_item_image_path(equipment_name.split(' ').join('_'));
                                document.getElementById("full-equip-first").title = equipment_name;
                                document.getElementById("full-equip-first-text").innerHTML = "\u00D7" + equipment_amount;
                                document.getElementById("full-equip-first-text").hidden = false;
                                break;
                            case 1:
                                document.getElementById("full-equip-second").src = "../../" + get_item_image_path(equipment_name.split(' ').join('_'));
                                document.getElementById("full-equip-second").title = equipment_name;
                                document.getElementById("full-equip-second-text").innerHTML = "\u00D7" + equipment_amount;
                                document.getElementById("full-equip-second-text").hidden = false;
                                break;
                            case 2:
                                document.getElementById("full-equip-third").src = "../../" + get_item_image_path(equipment_name.split(' ').join('_'));
                                document.getElementById("full-equip-third").title = equipment_name;
                                document.getElementById("full-equip-third-text").innerHTML = "\u00D7" + equipment_amount;
                                document.getElementById("full-equip-third-text").hidden = false;
                                break;
                        }
                    }
                    else
                    {
                        // SUBTRACTING 3 BECAUSE OF THE TOP 3 ITEM PLACEMENT
                        let bottom_item_counter = item_counter - 3;

                        // ADD TABLE ROW START IF FIRST ITEM
                        if (bottom_item_counter === 0) {
                            bottom_equipment_html += "<tr>";
                        }

                        // CLOSE TABLE ROW AND START NEW IF <table_row_length> ITEMS HAVE BEEN MADE
                        if (bottom_item_counter % table_row_length === 0 && bottom_item_counter !== 0) {
                            bottom_equipment_html += "</tr><tr>";
                        }

                        bottom_equipment_html += "<th>";
                        bottom_equipment_html += "<img class=\"item\" title=\"#" + (item_counter + 1) + "\n" + equipment_name + "\" src=\"../../" + get_item_image_path(equipment_name.split(' ').join('_')) + "\" alt=\"\">";
                        bottom_equipment_html += "<div class=\"item-amount\">\u00D7" + equipment_amount + "</div>";
                        bottom_equipment_html += "</th>";
                    }
                    item_counter++;
                }
            }
        }
        bottom_equipment_html += "</tr></tbody>";
        document.getElementById("all-equipment-sorted").innerHTML = bottom_equipment_html;
        document.getElementById("all-equipment").hidden = false;
    }

    function build_full_ingredient_html()
    {
        let item_counter = 0;
        let bottom_ingredient_html = "<tbody>";

        for (let [ingredient_name, ingredient_amount] of all_ingredients_map_sorted)
        {
            if (!ignored_rarities.includes(equipment_data_map.get(ingredient_name.replace(' Fragment', '')).get("rarity")))
            {
                if (item_counter < 3)
                {
                    switch (item_counter)
                    {
                        case 0:
                            document.getElementById("ingredient-first").src = "../../" + get_item_image_path(ingredient_name.split(' ').join('_'));
                            document.getElementById("ingredient-first").title = ingredient_name;
                            document.getElementById("ingredient-first-text").innerHTML = "\u00D7" + ingredient_amount;
                            document.getElementById("ingredient-first-text").hidden = false;
                            break;
                        case 1:
                            document.getElementById("ingredient-second").src = "../../" + get_item_image_path(ingredient_name.split(' ').join('_'));
                            document.getElementById("ingredient-second").title = ingredient_name;
                            document.getElementById("ingredient-second-text").innerHTML = "\u00D7" + ingredient_amount;
                            document.getElementById("ingredient-second-text").hidden = false;
                            break;
                        case 2:
                            document.getElementById("ingredient-third").src = "../../" + get_item_image_path(ingredient_name.split(' ').join('_'));
                            document.getElementById("ingredient-third").title = ingredient_name;
                            document.getElementById("ingredient-third-text").innerHTML = "\u00D7" + ingredient_amount;
                            document.getElementById("ingredient-third-text").hidden = false;
                            break;
                    }
                }
                else
                {
                    // SUBTRACTING 3 BECAUSE OF THE TOP 3 ITEM PLACEMENT
                    let bottom_item_counter = item_counter - 3;

                    // ADD TABLE ROW START IF FIRST ITEM
                    if (bottom_item_counter === 0) {
                        bottom_ingredient_html += "<tr>";
                    }

                    // CLOSE TABLE ROW AND START NEW IF <table_row_length> ITEMS HAVE BEEN MADE
                    if (bottom_item_counter % table_row_length === 0 && bottom_item_counter !== 0) {
                        bottom_ingredient_html += "</tr><tr>";
                    }

                    bottom_ingredient_html += "<th>";
                    bottom_ingredient_html += "<img class=\"item\" title=\"#" + (item_counter + 1) + "\n" + ingredient_name + "\" src=\"../../" + get_item_image_path(ingredient_name.split(' ').join('_')) + "\" alt=\"\">";
                    bottom_ingredient_html += "<div class=\"item-amount\">\u00D7" + ingredient_amount + "</div>";
                    bottom_ingredient_html += "</th>";
                }
                item_counter++;
            }
        }
        bottom_ingredient_html += "</tr></tbody>";
        document.getElementById("all-ingredients-sorted").innerHTML = bottom_ingredient_html;
        document.getElementById("all-ingredients").hidden = false;
    }

    function toggle_ignored_rarity(rarity)
    {
        let elem_id = "ignore-button-" + rarity;
        if (ignored_rarities.length !== 4 || document.getElementById(elem_id).classList.contains("low-opacity"))
        {
            document.getElementById(elem_id).classList.toggle("low-opacity");

            if (ignored_rarities.includes(rarity))
            {
                // UN-IGNORE RARITY
                let index = ignored_rarities.indexOf(rarity);
                if (index > -1)
                {
                    ignored_rarities.splice(index, 1);
                }
            }
            else
            {
                // IGNORE RARITY
                ignored_rarities.push(rarity);
            }

            build_full_equipment_html();
            build_full_ingredient_html();
        }
        else
        {
            toastr.error("At least one rarity must be enabled.", "Warning", { positionClass: "toast-top-full-width", tapToDismiss: false, preventDuplicates: true});
        }
    }

    function change_display()
    {
        let selected_option = document.getElementById("data-type-select").value;

        document.getElementById(current_display).hidden = true;
        document.getElementById(selected_option).hidden = false;
        current_display = selected_option;
    }
    
    function update_stats()
    {
        document.getElementById("stats").innerHTML = "Data From: <span style='color: #6DFF7F'>" + character_counter + "</span> Characters (Rank 1 to Rank " + highest_rank + ")";
        document.getElementById("stats-footer").hidden = false;
    }

    function change_equipment_data()
    {
        let equipment_data_type = document.getElementById("equipment-data-type").value;
        let character_data_type = (equipment_data_type === equipment_data_version.CURRENT) ? character_data_version.CURRENT : character_data_version.LEGACY;

        // CLEAR OUT EQUIPMENT AND CHARACTER MAPS
        equipment_map = new Map();
        character_map = new Map();

        // READ NEW EQUIPMENT DATA
        read_equipment_data(equipment_data_type, function ()
        {
            // READ NEW CHARACTER DATA
            read_character_data(character_data_type, function ()
            {
                run();
            });
        });
    }

    function setup_version_history()
    {
        // NUMBER BETWEEN () IS THE AMOUNT OF ENTRIES OBTAINED.
        // ENTRY AMOUNT MAX IS 30
        const ENTRY_AMOUNT = (5) - 1;
        let select_html = "";

        get_raw_urls(function (file_json) {
            let counter = 0;
            // GO THROUGH RAW URLS OBTAINED FROM get_raw_urls() AND BUILD version_history_json
            for (const [sha, obj] of Object.entries(file_json)) {
                // ADD SELECT OPTION
                select_html += "<option value='" + sha + "'>" + new Date(obj["date"]).toDateString() + "</option>";

                if (counter === 0) {
                    document.getElementById("version-after-link").href = "https://github.com/Expugn/priconne-quest-helper/commit/" + sha;
                    document.getElementById("version-before-link").href = "https://github.com/Expugn/priconne-quest-helper/commit/" + sha;
                }

                // GO THROUGH EQUIPMENT DATA OF SPECIFIC COMMIT
                get_items(obj["raw_url"], function (items_json) {
                    // ADD ITEMS
                    file_json[sha]["items"] = items_json;

                    // WHEN ENOUGH DATA HAS BEEN COLLECTED...
                    // SETUP ELEMENTS
                    if (counter++ === ENTRY_AMOUNT) {
                        // SETUP ELEMENTS
                        document.getElementById("version-history-button").disabled = false;
                        document.getElementById("version-after").innerHTML = select_html;
                        document.getElementById("version-before").innerHTML = select_html;

                        // STORE VERSION HISTORY FOR LATER USE
                        version_history_json = file_json;
                    }
                });
            }
        });

        function get_raw_urls(callback) {
            // FIND ANY COMMITS THAT HAVE MODIFIED data/character_data.json
            const commits_url = "https://api.github.com/repos/Expugn/priconne-quest-helper/commits?path=data/character_data.json";
            let file_json = {};
            $.ajax({
                url: commits_url,
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    $.each(response, function (index, obj) {
                        file_json[obj["sha"]] = {};
                        file_json[obj["sha"]]["raw_url"] = "https://raw.githubusercontent.com/Expugn/priconne-quest-helper/" + obj["sha"] + "/data/character_data.json";
                        file_json[obj["sha"]]["date"] = obj["commit"]["author"]["date"];
                        file_json[obj["sha"]]["items"] = {};

                        // END LOOP WHEN INDEX = ENTRY_AMOUNT (ENOUGH COMMIT DATA HAS BEEN COLLECTED)
                        if (index === ENTRY_AMOUNT) {
                            return false;
                        }
                    });

                    // RETURN RAW URLS TO CALLBACK
                    callback(file_json);
                },
                error: function(e) {
                    console.log(get_colored_message("Version History", "FAILED TO GET VERSION HISTORY! Page refresh may be necessary.", message_status.SUCCESS));

                    // MODIFY ELEMENTS
                    document.getElementById("version-history-button").innerHTML = "FAILED TO GET VERSION HISTORY<br>Refresh the page to try again.";
                }
            });
        }

        function get_items(raw_url, callback)
        {
            let items_json = {};
            $.ajax({
                url: raw_url,
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    $.when(
                        $.each(response, function(i, character_obj) {
                            for (let i = 1 ; character_obj["rank_" + i] !== undefined ; i++) {
                                character_obj["rank_" + i].forEach(function (item_name) {
                                    // CHECK IF ITEM IS EMPTY OR NOT
                                    if (item_name !== "") {
                                        // CHECK IF ENTRY EXISTS, IF NOT THEN CREATE NEW ENTRY
                                        if (items_json[item_name] !== undefined) {
                                            items_json[item_name]++;
                                        }
                                        else {
                                            items_json[item_name] = 1;
                                        }
                                    }
                                });
                            }
                        })
                    ).then(function () {
                        callback(items_json);
                    });
                },
                error: function(e) {
                    console.log(get_colored_message("Version History", "FAILED TO GET ITEMS FROM RAW URLS! Page refresh may be necessary.", message_status.SUCCESS));

                    // MODIFY ELEMENTS
                    document.getElementById("version-history-button").innerHTML = "FAILED TO GET VERSION HISTORY<br>Refresh the page to try again.";
                }
            });
        }
    }

    function compare_versions()
    {
        let equipment_html = "";
        let ingredient_html = "";
        const version_1 = version_history_json[document.getElementById("version-after").value];
        const version_2 = version_history_json[document.getElementById("version-before").value];
        let items = {...version_2["items"], ...version_1["items"]};
        let ingredients = new Map();

        // DETERMINE DIFFERENCES
        Object.entries(items).forEach(function (item)
        {
            const item_name = item[0];
            let difference = items[item_name] - (version_2["items"].hasOwnProperty(item_name) ? version_2["items"][item_name] : 0);
            let is_new_item = (version_1["items"].hasOwnProperty(item_name) && !version_2["items"].hasOwnProperty(item_name)) ||
                (!version_1["items"].hasOwnProperty(item_name) && version_2["items"].hasOwnProperty(item_name));
            if (difference !== 0 || is_new_item) {
                if (is_new_item && (!version_1["items"].hasOwnProperty(item_name) && version_2["items"].hasOwnProperty(item_name))) {
                    // ITEM EXISTS IN VERSION_2 BUT NOT VERSION_1, MEANING VERSION_2 IS PROBABLY A MORE RECENT VERSION.
                    items[item_name] = -(version_2["items"][item_name]);
                }
                else {
                    // THERE IS A DIFFERENCE IN AMOUNTS, ADD TO ITEMS.
                    items[item_name] = difference;
                }
            }
            else
            {
                // NO DIFFERENCE DETECTED, REMOVE FROM LIST
                delete items[item_name];
            }
        });

        if (Object.keys(items).length === 0 && items.constructor === Object)
        {
            // NO CHANGES BETWEEN VERSIONS DETECTED
            const no_changes_detected_html = "<div style='margin: auto; text-align: center;'><br><span style='font-family: \"Trebuchet MS\", Arial, serif;'>No Changes Detected!</span></div>";
            document.getElementById("equipment-history").innerHTML = no_changes_detected_html;
            document.getElementById("fragment-history").innerHTML = no_changes_detected_html;
        }
        else
        {
            // SORT ITEMS (MOST -> LEAST)
            let items_sorted = Object.keys(items).sort(function (a, b) {
                return items[b]-items[a];
            });

            // MAKE EQUIPMENT HTML
            items_sorted.forEach(function (item_name) {
                const difference = items[item_name];
                equipment_html += "<div class='item-div" + (difference > 0 ? " green-background" : " red-background") + "'>";
                equipment_html += "<img class='item' src=\"../../" + get_item_image_path(item_name.split(' ').join('_')) + "\" title=\"" + item_name + "\" alt=''>";
                equipment_html += "<span class='item-amount version-item-amount'>" + ((difference > 0) ? "+ " : "- ") + Math.abs(difference) + "</span>";
                equipment_html += "</div>";

                // COLLECT AND STORE RECIPE DATA FOR LATER USE
                let item_recipe = get_recipe(item_name, Math.abs(difference));
                item_recipe.forEach(function (ingredient_amount, ingredient_name) {
                    if (ingredients.has(ingredient_name)) {
                        if (difference > 0) {
                            ingredients.set(ingredient_name, ingredients.get(ingredient_name) + ingredient_amount);
                        }
                        else {
                            ingredients.set(ingredient_name, ingredients.get(ingredient_name) + (-Math.abs(ingredient_amount)));
                        }
                    }
                    else {
                        if (difference > 0) {
                            ingredients.set(ingredient_name, ingredient_amount);
                        }
                        else {
                            ingredients.set(ingredient_name, (-Math.abs(ingredient_amount)));
                        }
                    }
                });
            });

            // BUILD INGREDIENT HTML
            new Map([...ingredients.entries()].sort((a, b) => b[1] - a[1])).forEach(function (ingredient_amount, ingredient_name) {
                if (ingredient_amount !== 0) {
                    ingredient_html += "<div class='item-div" + (ingredient_amount > 0 ? " green-background" : " red-background") + "'>";
                    ingredient_html += "<img class='item' src=\"../../" + get_item_image_path(ingredient_name.split(' ').join('_')) + "\" title=\"" + ingredient_name + "\" alt=''>";
                    ingredient_html += "<span class='item-amount version-item-amount'>" + ((ingredient_amount > 0) ? "+ " : "- ") + Math.abs(ingredient_amount) + "</span>";
                    ingredient_html += "</div>";
                }
            });
            document.getElementById("equipment-history").innerHTML = equipment_html;
            document.getElementById("fragment-history").innerHTML = ingredient_html;
        }
    }

    let temp_ignored_rarities = [];
    function toggle_version_history_display()
    {
        document.getElementById("rarity-settings").hidden = !document.getElementById("rarity-settings").hidden;
        document.getElementById("version-settings").hidden = !document.getElementById("version-settings").hidden;
        document.getElementById("all-data").hidden = !document.getElementById("all-data").hidden;
        document.getElementById("version-history").hidden = !document.getElementById("version-history").hidden;

        // IF LOOKING AT VERSION HISTORY, CLEAR IGNORED RARITIES
        // ELSE, RESTORE SAVED SETTINGS.
        if (document.getElementById("rarity-settings").hidden) {
            temp_ignored_rarities = ignored_rarities;
            ignored_rarities = [];
        }
        else {
            ignored_rarities = temp_ignored_rarities;
        }
    }
    
    function toggle_version_history_type() {
        document.getElementById("equipment-history").hidden = !document.getElementById("equipment-history").hidden;
        document.getElementById("fragment-history").hidden = !document.getElementById("fragment-history").hidden;
    }
</script>

</html>
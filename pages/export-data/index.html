<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>priconne-quest-helper - Export Data</title>
    <link rel="icon" href="../../images/webpage/thumb_equipment_randomreward_01.png">

    <!-- META DATA -->
    <meta name="author" content="S'pugn">

    <meta name="description" content="priconne-quest-helper Data Export">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta charset="UTF-8">

    <!-- OPEN GRAPH META DATA -->
    <meta property="og:title" content="priconne-quest-helper Data Export">
    <meta property="og:image" content="https://raw.githubusercontent.com/Expugn/priconne-quest-helper/master/images/webpage/thumb_equipment_randomreward_01.png">
    <meta property="og:description" content="priconne-quest-helper Data Export">

    <!-- TWITTER META DATA -->
    <meta property="twitter:title" content="priconne-quest-helper Data Export">
    <meta property="twitter:image" content="https://raw.githubusercontent.com/Expugn/priconne-quest-helper/master/images/webpage/thumb_equipment_randomreward_01.png">
    <meta property="twitter:description" content="priconne-quest-helper Data Export">

    <!-- SCRIPTS -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="../../scripts/private-information.js"></script>
    <script src="../../scripts/url-parser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script src="../../scripts/toastrOptions.js"></script>

    <!-- CSS STYLE SHEETS -->
    <link rel="stylesheet" href="../../css/export_import.css">
    <link rel="stylesheet" href="../../css/item_table.css">
    <link rel="stylesheet" href="../../css/toastr.css"/>
</head>

<body>
    <div>
        <h1 class="title">Princess Connect! Re:Dive - Quest Helper</h1>
        <h2 id="sub-title" class="title">Data Export</h2>
    </div>

    <hr>

    <div id="export-failure" style="display: none">
        <h2 class='align-center'>LocalStorage is Not Supported On This Browser!<br>Data Exporting Will Not Function Properly.</h2>
    </div>

    <div id="all-export-elements">
        <div id="export-settings">
            <h2 class='align-center'>Export Options</h2>

            <table class="center">
                <tbody>
                <tr class="export">
                    <th class="export"><label class="center" for="include-projects">Projects</label></th>
                    <th class="export"><label class="center" for="include-blacklist">Blacklist</label></th>
                    <th class="export"><label class="center" for="include-settings">Settings</label></th>
                </tr>
                <tr class="export">
                    <td class="export"><input id="include-projects" type="checkbox" checked onchange="checked_checkbox()"></td>
                    <td class="export"><input id="include-blacklist" type="checkbox" checked onchange="checked_checkbox()"></td>
                    <td class="export"><input id="include-settings" type="checkbox" onchange="checked_checkbox()"></td>
                </tr>
                <tr class="export">
                    <td class="export"></td>
                    <td class="export">
                        <button id="generate-url-button" type="button" class="align-right" onclick="generate_url()">Generate URL</button>
                    </td>
                    <td class="export"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div id="generated-links" style="display: none">
            <table class="center">
                <tbody>
                <tr>
                    <th><h3 id="short-url">[ Short URL Not Generated ]</h3></th>
                </tr>
                <tr>
                    <td><textarea id="long-url" rows="10" cols="100" disabled></textarea></td>
                </tr>
                <tr>
                    <td class="export">
                        <button id="generate-short-url-button" type="button" class="align-right" onclick="generate_short_url()">Generate Short URL</button>
                        <button id="copy-short-url-button" type="button" class="align-right" style="display: none;" onclick="copyShortURLToClipboard()">Copy Short URL to Clipboard</button>
                        <button type="button" class="align-right" onclick="copyLongURLToClipboard()">Copy Long URL to Clipboard</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <hr>

        <div id="project-display"></div>
        <div id="blacklist-display"></div>
        <div id="settings-display"></div>
    </div>

</body>

<footer>

</footer>

<script>
    let project_data;
    let blacklist_data;
    let settings_data;

    let projects_data_provided;
    let blacklist_data_provided;
    let settings_data_provided;

    let project_json;
    let blacklist_json;
    let settings_json;

    if (typeof(Storage) !== "undefined")
    {
        setToastrOptions();
        build_data_tables();
        checked_checkbox();
    }
    else
    {
        document.getElementById("all-export-elements").style.display = "none";
        document.getElementById("export-failure").style.display = "block";
    }

    function build_data_tables()
    {
        try
        {
            project_data = get_data_from_url("projects");
            blacklist_data = get_data_from_url("blacklist");
            settings_data = get_data_from_url("settings");

            projects_data_provided = project_data !== "";
            blacklist_data_provided = blacklist_data !== "";
            settings_data_provided = settings_data !== "";

            project_json = (projects_data_provided ? JSON.parse(project_data) : "");
            blacklist_json = (blacklist_data_provided ? JSON.parse(blacklist_data) : "");
            settings_json = (settings_data_provided ? JSON.parse(settings_data) : "");

            url_success();
        }
        catch (err)
        {
            // ERROR WITH URL?
            document.getElementById("all-export-elements").style.display = "none";
            document.getElementById("export-failure").innerHTML = "<h2 class='align-center'>Invalid URL Provided!</h2>";
            document.getElementById("export-failure").style.display = "block";
        }
    }

    function url_success()
    {
        if (!projects_data_provided && !blacklist_data_provided && !settings_data_provided)
        {
            document.getElementById("all-export-elements").style.display = "none";
            document.getElementById("export-failure").style.display = "block";
            document.getElementById("export-failure").innerHTML = "<h2 class='align-center'>There is No Data Saved That Can Be Exported!</h2>";
        }
        else
        {
            if (projects_data_provided) { build_project_display(); }
            else
            {
                document.getElementById("include-projects").checked = false;
                document.getElementById("include-projects").disabled = true;
            }
            if (blacklist_data_provided) { build_blacklist_display(); }
            else
            {
                document.getElementById("include-blacklist").checked = false;
                document.getElementById("include-blacklist").disabled = true;
            }
            if (settings_data_provided) { build_settings_display(); }
            else
            {
                document.getElementById("include-settings").checked = false;
                document.getElementById("include-settings").disabled = true;
            }
        }
    }

    function build_project_display()
    {
        // SAVE MAP JSON STRING AS MAP OF JSON STRINGS
        let map_of_json_strings = new Map(project_json);

        // SAVE MAP OF JSON STRINGS AS MAP OF MAPS
        let project_map = new Map();
        for (let [project_name, data_string_json] of map_of_json_strings)
        {
            project_map.set(project_name, JSON.parse(data_string_json));
        }

        let project_display_HTML = "<h1 class=\"align-center\">⸻ Projects ⸻</h1>";
        project_display_HTML += "<h4 class=\"align-center item-count\">" + project_map.size + " project(s) found.</h4>";

        for (let [project_name, project_data] of project_map)
        {
            // PRINT PROJECT NAME
            project_display_HTML += "<h3 class='project-title' style='font-style: oblique'>\"" + project_name + "\"</h3>";

            // PRINT PROJECT ITEMS

            // NEW TABLE + OPEN TBODY
            let count = 0;
            project_display_HTML += "<div class=\"auto-overflow\"><table class=\"centerTable\"><tbody>";

            for (let [item_name, item_amount] of project_data)
            {
                // ADD TABLE ROW START IF FIRST ITEM
                if (count === 0)
                {
                    project_display_HTML += "<tr>";
                }

                if (count % 7 === 0 && count !== 0)
                {
                    project_display_HTML += "</tr><tr>";
                }

                // ITEM IMAGE
                project_display_HTML += "<th class=\"requested-item-image\">";
                $.ajax({
                    url: "/" + window.location.pathname.substring(0, window.location.pathname.indexOf('/')) + window.location.pathname.split('/')[1] + "/images/items/" + item_name.split(' ').join('_') + ".png",
                    type: 'HEAD',
                    error: function ()
                    {
                        data_failure();
                    }
                });

                project_display_HTML += "<img " +
                    "class=\"requested-item-image\" " +
                    "title=\"" + item_name + "\" " +
                    "src=\"../../images/items/" + item_name.split(' ').join('_') + ".png\" " +
                    "alt=\"\">";
                project_display_HTML += "<div class=\"requested-item-text\">\u00D7" + item_amount + "</div>";

                count++;
            }

            // CLOSE TBODY AND TABLE
            project_display_HTML += "</tbody></table></div>";
        }
        project_display_HTML += "<br><hr>";

        document.getElementById("project-display").innerHTML = project_display_HTML;
    }

    function build_blacklist_display()
    {
        // SAVE MAP JSON STRING AS ARRAY
        let blacklist_array = blacklist_json;

        let blacklist_display_HTML = "<h1 class=\"align-center\">⸻ Blacklist ⸻</h1>";
        blacklist_display_HTML += "<h4 class=\"align-center item-count\">" + blacklist_array.length + " blacklisted item(s) found.</h4><br>";

        // NEW TABLE + OPEN TBODY
        let count = 0;
        blacklist_display_HTML += "<div class=\"auto-overflow\"><table class=\"centerTable\"><tbody>";
        for (let i = 0 ; i < blacklist_array.length ; i++)
        {
            let item_name = blacklist_array[i];

            // ADD TABLE ROW START IF FIRST ITEM
            if (count === 0)
            {
                blacklist_display_HTML += "<tr>";
            }

            if (count % 7 === 0 && count !== 0)
            {
                blacklist_display_HTML += "</tr><tr>";
            }

            // ITEM IMAGE
            blacklist_display_HTML += "<th class=\"requested-item-image\">";
            $.ajax({
                url: "/" + window.location.pathname.substring(0, window.location.pathname.indexOf('/')) + window.location.pathname.split('/')[1] + "/images/items/" + item_name.split(' ').join('_') + ".png",
                type: 'HEAD',
                error: function ()
                {
                    data_failure();
                }
            });

            blacklist_display_HTML += "<img " +
                "class=\"requested-item-image low-opacity\" " +
                "title=\"" + item_name + "\" " +
                "src=\"../../images/items/" + item_name.split(' ').join('_') + ".png\" " +
                "alt=\"\">";

            count++;
        }

        // CLOSE TBODY AND TABLE
        blacklist_display_HTML += "</tbody></table></div><br><hr>";

        document.getElementById("blacklist-display").innerHTML = blacklist_display_HTML;
    }

    function build_settings_display()
    {
        let saved_settings_map = settings_json;

        // CHECK FOR MISSING SETTINGS
        if (!saved_settings_map.hasOwnProperty("quest_shown_value") ||
            !saved_settings_map.hasOwnProperty("ascending_sort_quest_list") ||
            !saved_settings_map.hasOwnProperty("ascending_sort_quest_score") ||
            !saved_settings_map.hasOwnProperty("hide_quest_score") ||
            !saved_settings_map.hasOwnProperty("min_quest_chapter") ||
            !saved_settings_map.hasOwnProperty("max_quest_chapter") ||
            !saved_settings_map.hasOwnProperty("quest_filter") ||
            !saved_settings_map.hasOwnProperty("item_amount_per_row") ||
            !(saved_settings_map.quest_filter === "filter-all" || saved_settings_map.quest_filter === "filter-normal" || saved_settings_map.quest_filter === "filter-hard"))
        {
            data_failure();
        }
        else
        {
            let settings_display_HTML = "<h1 class=\"align-center\">⸻ Settings ⸻</h1>";
            settings_display_HTML += "<table class='center'><tbody><tr><td>";
            settings_display_HTML += "<textarea rows='10' cols='50' disabled>";

            let dump = JSON.stringify(saved_settings_map, null, 4);
            settings_display_HTML += dump;

            settings_display_HTML += "</textarea></td></tr></tbody></table><br><hr>";

            document.getElementById("settings-display").innerHTML = settings_display_HTML;
        }
    }

    function data_failure()
    {
        document.getElementById("all-export-elements").style.display = "none";
        document.getElementById("export-failure").style.display = "block";
        document.getElementById("export-failure").innerHTML = "<h2 class='align-center'>Invalid Data Provided!</h2>";
    }

    function generate_url()
    {
        let include_projects = document.getElementById("include-projects").checked;
        let include_blacklist = document.getElementById("include-blacklist").checked;
        let include_settings = document.getElementById("include-settings").checked;

        let url = window.location.protocol + "//" + window.location.host + "/" + window.location.pathname.substring(0, window.location.pathname.indexOf('/')) + window.location.pathname.split('/')[1] + "/pages/import-data/?";

        if (include_projects)
        {
            url += "projects=" + encodeURI(get_data_from_url("projects"));
        }
        else
        {
            url += "projects=";
        }


        if (include_blacklist)
        {
            if (include_projects)
            {
                url += "&";
            }
            url += "blacklist=" + encodeURI(get_data_from_url("blacklist"));
        }
        else
        {
            url += "&";
            url += "blacklist=";
        }
        if (include_settings)
        {
            if (include_settings || include_blacklist)
            {

            }
            url += "&";
            url += "settings=" + encodeURI(get_data_from_url("settings"));
        }
        else
        {
            url += "&";
            url += "settings=";
        }

        // REPLACE localhost SO THAT BIT.LY WORKS
        url = url.replace("localhost:63342", "expugn.github.io");

        document.getElementById("long-url").innerHTML = url;

        document.getElementById("generated-links").style.display = "block";
        document.getElementById("export-settings").style.display = "none";

        return url;
    }

    function copyShortURLToClipboard()
    {
        let dummy = document.createElement("input");
        document.body.appendChild(dummy);
        dummy.setAttribute('value', document.getElementById("short-url").innerHTML);
        dummy.select();
        document.execCommand("copy");
        document.body.removeChild(dummy);

        toastr.info("Copied Short URL to Clipboard!");
    }

    function copyLongURLToClipboard()
    {
        let dummy = document.createElement("input");
        document.body.appendChild(dummy);
        dummy.setAttribute('value', document.getElementById("long-url").innerHTML.replace(/amp;/g, ""));
        dummy.select();
        document.execCommand("copy");
        document.body.removeChild(dummy);

        toastr.info("Copied Long URL to Clipboard!");
    }

    function generate_short_url()
    {
        let url = document.getElementById("long-url").innerHTML.replace(/amp;/g, "");
        function getShortUrl(url, callback)
        {
            var accessToken = BITLY_ACCESS_TOKEN;
            var url = 'https://api-ssl.bitly.com/v3/shorten?access_token=' + accessToken + '&longUrl=' + encodeURIComponent(url);

            $.getJSON(
                url,
                {},
                function(response)
                {
                    if(callback)
                        callback(response.data.url);
                    document.getElementById("short-url").innerHTML = response.data.url;
                }
            );
        }

        getShortUrl(url, function (url) {});
        document.getElementById("copy-short-url-button").style.display = "inline";
        document.getElementById("generate-short-url-button").style.display = "none";

        console.log("[Export] - Short URL Generated.");
    }

    function checked_checkbox()
    {
        if (!(document.getElementById("include-projects").checked || document.getElementById("include-blacklist").checked || document.getElementById("include-settings").checked))
        {
            document.getElementById("generate-url-button").disabled = true;
        }
        else
        {
            document.getElementById("generate-url-button").disabled = false;
        }
    }
</script>

</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <link rel="icon" href="../../images/webpage/thumb_equipment_randomreward_01.png">

    <title>priconne-quest-helper Data Export</title>
    <meta name="title" content="priconne-quest-helper Data Export"/>

    <!-- META DATA -->
    <meta name="description" content="priconne-quest-helper Data Export">
    <meta name="author" content="S'pugn">

    <!-- OPEN GRAPH / FACEBOOK META DATA -->
    <meta property="og:title" content="priconne-quest-helper Data Export"/>
    <meta property="og:description" content="priconne-quest-helper Data Exporting - Transfer Data Between Devices!"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://raw.githubusercontent.com/Expugn/priconne-quest-helper/master/images/webpage/thumb_equipment_randomreward_01.png"/>
    <meta property="og:image:width" content="50"/>
    <meta property="og:image:height" content="50"/>
    <meta property="og:url" content="https://expugn.github.io/priconne-quest-helper/"/>
    <meta property="og:locale" content="en_US"/>

    <!-- TWITTER META DATA -->
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="@eSpugn"/>
    <meta name="twitter:creator" content="@eSpugn"/>
    <meta name="twitter:title" content="priconne-quest-helper Data Export"/>
    <meta name="twitter:description" content="priconne-quest-helper Data Exporting - Transfer Data Between Devices!"/>

    <!-- SCRIPTS -->
    <script src="../../vendor/jquery/jquery-3.4.1.min.js"></script>
    <script src="../../scripts/console.js"></script>
    <script src="../../scripts/read-equipment-json.js"></script>
    <script src="../../scripts/display-data.js"></script>
    <script src="../../scripts/url-parser.js"></script>
    <script src="../../vendor/toastr/toastr.min.js"></script>
    <script src="../../scripts/toastrOptions.js"></script>
    <script src="../../scripts/github-gists.js"></script>
    <script src="../../vendor/modernizr/modernizr-custom.js"></script> <!-- WEBP CHECK -->
    <script src="../../scripts/image-manager.js"></script>

    <!-- CSS STYLE SHEETS -->
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/export_import.css">
    <link rel="stylesheet" href="../../vendor/toastr/toastr.css"/>
</head>

<body>
<noscript>
    <style type="text/css">
        div {display: none;}
        hr {display: none;}
        footer {display: none;}
    </style>
    <h1 style="color: white; font-family: 'Trebuchet MS', Arial, serif; text-align:center; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-shadow: 1px 1px 3px #000000, 1px 1px 4px #000000;">
        <span style="color: orangered;">JavaScript is disabled!</span>
        <br><br>
        <span style="color: #e3cfcb;">priconne-quest-helper/export-data/</span> cannot function without JavaScript.
        <br><br>
        <span style="color: #ffdf73;">Please enable JavaScript to continue!</span>
    </h1>
</noscript>

    <div>
        <h1 class="title">Princess Connect! Re:Dive - Quest Helper</h1>
        <h2 id="sub-title" class="title">Data Export</h2>
    </div>

    <hr>

    <div id="gist-create-iframe" style="display: none">
        <!-- REPLACE URL WITH LATEST HEROKU URL -->
        <iframe id="gist-creator" name="gist-creator" src="https://thawing-fortress-48694.herokuapp.com/"></iframe>
    </div>


    <div id="localstorage-failure" style="display: none">
        <h2 class='align-center'>
            LocalStorage is Not Supported On This Browser!<br>
            Data Exporting Will Not Function Properly.
        </h2>
    </div>

    <div id="export-failure" style="display: none">
        <h2 class='align-center'></h2>
    </div>

    <div id="all-export-elements" style="display: none">
        <div id="export-settings" style="overflow-x: auto;">
            <h2 class='align-center'>Export Options</h2>
            <table class="center">
                <tbody>
                <tr class="export">
                    <th class="export"><label class="center" for="include-projects">Projects</label></th>
                    <th class="export"><label class="center" for="include-blacklist">Blacklist</label></th>
                    <th class="export"><label class="center" for="include-settings">Settings</label></th>
                </tr>
                <tr class="export">
                    <td class="export"><input id="include-projects" type="checkbox" checked onchange="checked_checkbox()"></td>
                    <td class="export"><input id="include-blacklist" type="checkbox" checked onchange="checked_checkbox()"></td>
                    <td class="export"><input id="include-settings" type="checkbox" onchange="checked_checkbox()"></td>
                </tr>
                <tr class="export">
                    <td class="export"></td>
                    <td class="export">
                        <button id="generate-url-button" type="button" class="align-center" onclick="generate_url()">Generate URL</button>
                    </td>
                    <td class="export"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div id="generated-links" style="display: none">
            <table class="center">
                <tbody>
                <tr>
                    <th><h4 id="url"></h4></th>
                </tr>
                <tr>
                    <td class="export">
                        <button type="button" class="align-center" onclick="copyURLToClipboard()">Copy URL to Clipboard</button>
                    </td>
                </tr>
                <tr>
                    <td style="text-align: center">
                        <br><br>
                        URLs older than a month will occasionally be purged.
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <hr>

        <div id="data-display"></div>
    </div>

</body>

<footer>

</footer>

<script>
    let project_data;
    let priority_project_data;
    let blacklist_data;
    let settings_data;

    let project_json;
    let priority_project_json;
    let blacklist_json;
    let settings_json;

    let url;
    let receiverWindow;

    let heroku_url = "https://thawing-fortress-48694.herokuapp.com";
    let sample_text = gist_max + gist_favorite_league_role + gist_year;
    window.onload = function()
    {
        receiverWindow = document.getElementById("gist-creator").contentWindow;
    };

    window.addEventListener('message', function (e)
    {
        if (~e.origin.indexOf(heroku_url))
        {
            console.log(e.data + " from " + heroku_url);

            url += e.data;

            document.getElementById("url").innerHTML = url;

            document.getElementById("generated-links").style.display = "block";
            document.getElementById("export-settings").style.display = "none";

            // URL CREATION COMPLETED
        }
        else
        {
            console.log("[Export Data] - Received message... but it's from the wrong url: " + e.origin);
        }

    });

    function send_data_to_heroku(content)
    {
        try
        {
            receiverWindow.postMessage(location.protocol+'//'+location.hostname+(location.port ? ':'+location.port: ''), heroku_url);
            receiverWindow.postMessage(content, heroku_url);
            receiverWindow.postMessage(sample_text, heroku_url);
            receiverWindow.postMessage("priconne_gist", heroku_url);
        }
        catch (err)
        {
            document.getElementById("export-failure").innerHTML = "<h2 class='align-center'>Failed to Send Data!<br>Refresh the page and try again.</h2>";
            document.getElementById("all-export-elements").style.display = "none";
            document.getElementById("export-failure").style.display = "block";
        }
    }

    toastr.warning("Loading...", "Status", { positionClass: "toast-top-full-width", timeOut:999999, extendedTimeOut:999999, tapToDismiss: false });
    setTimeout(function () {
        if (typeof(Storage) !== "undefined")
        {
            setToastrOptions();
            build_data_tables();
            checked_checkbox();
        }
        else
        {
            document.getElementById("localstorage-failure").style.display = "block";
        }
        toastr.remove();
    }, 1000);



    function build_data_tables()
    {
        try
        {
            project_data = localStorage.getItem('projects');
            priority_project_data = localStorage.getItem('priority_projects');
            blacklist_data = localStorage.getItem('blacklist');
            settings_data = localStorage.getItem('settings');

            project_json = (project_data !== null ? JSON.parse(project_data) : "");
            priority_project_json = (priority_project_data !== null ? JSON.parse(priority_project_data) : "");
            blacklist_json = (blacklist_data !== null ? JSON.parse(blacklist_data) : "");
            settings_json = (settings_data !== null ? JSON.parse(settings_data) : "");

            sample_text += gist_seed_string + gist_number_of_users;

            data_success();
        }
        catch (err)
        {
            document.getElementById("export-failure").innerHTML = "<h2 class='align-center'>Invalid Data Received!</h2>";
            document.getElementById("export-failure").style.display = "block";
        }
    }

    function data_success()
    {
        try
        {
            display_data("data-display", project_json, blacklist_json, settings_json);

            if (project_data === null)
            {
                document.getElementById("include-projects").checked = false;
                document.getElementById("include-projects").disabled = true;
            }
            if (blacklist_data === null)
            {
                document.getElementById("include-blacklist").checked = false;
                document.getElementById("include-blacklist").disabled = true;
            }
            if (settings_data === null)
            {
                document.getElementById("include-settings").checked = false;
                document.getElementById("include-settings").disabled = true;
            }

            document.getElementById("all-export-elements").style.display = "block";
        }
        catch (error_message)
        {
            document.getElementById("export-failure").innerHTML = "<h2 class='align-center'>" + error_message + "</h2>";
            document.getElementById("export-failure").style.display = "block";
        }
    }


    function generate_url()
    {
        // DISABLE GENERATE URL BUTTON SO USER DOESN'T SPAM IT
        document.getElementById("generate-url-button").disabled = true;
        document.getElementById("include-projects").disabled = true;
        document.getElementById("include-blacklist").disabled = true;
        document.getElementById("include-settings").disabled = true;
        sample_text += gist_id_value + gist_color_code;

        // TEST IF RATE LIMITED HERE
        check_rate_limit_status(sample_text, function (is_rate_limited, date_string)
        {
            if (!is_rate_limited)
            {
                // DO STUFF
                let include_projects = document.getElementById("include-projects").checked;
                let include_blacklist = document.getElementById("include-blacklist").checked;
                let include_settings = document.getElementById("include-settings").checked;

                url = window.location.protocol + "//" + window.location.host + "/" + window.location.pathname.substring(0, window.location.pathname.indexOf('/')) + window.location.pathname.split('/')[1] + "/pages/import-data/?id=";

                let content;
                let content_map = new Map();
                if (include_projects)
                {
                    content_map["projects"] = localStorage.getItem('projects');
                    if (priority_project_data !== null)
                    {
                        content_map["priority_projects"] = localStorage.getItem('priority_projects');
                    }
                }
                else if (project_data !== null) { document.getElementById("project-display").style.display = "none"; }
                if (include_blacklist) { content_map["blacklist"] = localStorage.getItem('blacklist'); }
                else if (blacklist_data !== null) { document.getElementById("blacklist-display").style.display = "none"; }
                if (include_settings) { content_map["settings"] = localStorage.getItem('settings'); }
                else if (settings_data !== null) { document.getElementById("settings-display").style.display = "none"; }

                content = JSON.stringify(content_map);

                console.log("[Data Export] - Content Generated: " + content);

                send_data_to_heroku(content);
            }
            else
            {
                // ABANDON SHIP, RATE LIMITED.
                document.getElementById("export-failure").innerHTML = "<h2 class='align-center'>Rate Limited!<br>Rate Limit Reset: " + date_string + "</h2>";
                document.getElementById("export-failure").style.display = "block";
            }
        });
    }

    function copyURLToClipboard()
    {
        let dummy = document.createElement("input");
        document.body.appendChild(dummy);
        dummy.setAttribute('value', document.getElementById("url").innerHTML);
        dummy.select();
        document.execCommand("copy");
        document.body.removeChild(dummy);

        toastr.info("Copied URL to Clipboard!");
    }

    function checked_checkbox()
    {
        document.getElementById("generate-url-button").disabled = !(document.getElementById("include-projects").checked || document.getElementById("include-blacklist").checked || document.getElementById("include-settings").checked);
    }

    function onMessage(messageEvent)
    {
        //console.log(messageEvent.data);
    }
</script>

</html>